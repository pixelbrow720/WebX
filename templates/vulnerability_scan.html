{% extends 'layout.html' %}

{% block title %}Vulnerability Scanning - Web Security Recon Tool{% endblock %}

{% block content %}
<div class="section">
    <h1 class="section-title">
        <i class="fas fa-shield-alt"></i> Vulnerability Scanning
    </h1>
    <p>Scan for common web vulnerabilities, security misconfigurations, and potential weaknesses.</p>
    
    <form method="POST" action="{{ url_for('vulnerability_scan') }}" class="needs-validation" novalidate>
        <div class="form-group mb-3">
            <label for="target">Target URL:</label>
            <input type="url" id="target" name="target" class="form-control" placeholder="https://example.com" required
                   value="{{ request.form.get('target', '') }}">
            <div class="invalid-feedback">
                Please enter a valid URL (e.g., https://example.com)
            </div>
            <small class="text-muted">Enter the full URL including http:// or https://</small>
        </div>
        
        <div class="form-group mb-3">
            <label>Scan Type:</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="scan_type" id="scan_type_quick" value="quick" 
                       {% if request.form.get('scan_type') != 'comprehensive' %}checked{% endif %}>
                <label class="form-check-label" for="scan_type_quick">
                    Quick Scan (Faster, less intensive)
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="scan_type" id="scan_type_comprehensive" value="comprehensive"
                       {% if request.form.get('scan_type') == 'comprehensive' %}checked{% endif %}>
                <label class="form-check-label" for="scan_type_comprehensive">
                    Comprehensive Scan (Slower, more thorough)
                </label>
            </div>
        </div>
        
        <div class="form-group mb-3">
            <label>Options:</label>
            <div class="checkbox-group">
                <input type="checkbox" class="form-check-input" id="zap_enabled" name="zap_enabled"
                       {% if 'zap_enabled' in request.form %}checked{% endif %}>
                <label class="form-check-label" for="zap_enabled">
                    Use OWASP ZAP for comprehensive scanning
                </label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" class="form-check-input" id="fuzzing_enabled" name="fuzzing_enabled"
                       {% if 'fuzzing_enabled' in request.form %}checked{% endif %}>
                <label class="form-check-label" for="fuzzing_enabled">
                    Perform parameter fuzzing
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i> Start Vulnerability Scan
            </button>
        </div>
    </form>
</div>

{% if results %}
<div class="section">
    <h2 class="section-title">
        <i class="fas fa-clipboard-list"></i> Vulnerability Scan Results
    </h2>
    
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">Target Information</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <tr>
                    <th width="30%">Target URL:</th>
                    <td>{{ results.target }}</td>
                </tr>
                <tr>
                    <th>Scan Type:</th>
                    <td>{{ results.scan_type|capitalize }}</td>
                </tr>
                <tr>
                    <th>Timestamp:</th>
                    <td>{{ results.timestamp }}</td>
                </tr>
            </table>
        </div>
    </div>
    
    {% if results.security_headers %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">Security Headers</h3>
        </div>
        <div class="card-body">
            {% if results.security_headers.missing_headers and results.security_headers.missing_headers|length > 0 %}
            <div class="alert alert-warning">
                <h4><i class="fas fa-exclamation-triangle"></i> Missing Security Headers</h4>
                <ul class="mb-0">
                    {% for header in results.security_headers.missing_headers %}
                    <li>
                        <strong>{{ header.header }}</strong>: {{ header.description }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% else %}
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> All essential security headers are present!
            </div>
            {% endif %}
            
            {% if results.security_headers.found_headers and results.security_headers.found_headers|length > 0 %}
            <h4 class="mt-4">Detected Headers</h4>
            <table class="table">
                <thead>
                    <tr>
                        <th>Header</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for header, value in results.security_headers.found_headers.items() %}
                    <tr>
                        <td>{{ header }}</td>
                        <td><code>{{ value }}</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% if results.cors_config %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">CORS Configuration</h3>
        </div>
        <div class="card-body">
            {% if results.cors_config.misconfigured %}
            <div class="alert alert-danger">
                <h4><i class="fas fa-exclamation-circle"></i> CORS Misconfiguration Detected!</h4>
                <p>{{ results.cors_config.risk }}</p>
            </div>
            {% elif results.cors_config.headers %}
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> CORS configuration appears to be secure.
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No CORS headers detected.
            </div>
            {% endif %}
            
            {% if results.cors_config.headers %}
            <h4 class="mt-4">CORS Headers</h4>
            <table class="table">
                <thead>
                    <tr>
                        <th>Header</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for header, value in results.cors_config.headers.items() %}
                    <tr>
                        <td>{{ header }}</td>
                        <td><code>{{ value }}</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% if results.status_codes %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">Directory/File Enumeration</h3>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>Status Code</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for check in results.status_codes %}
                        <tr {% if check.interesting %}class="table-warning"{% endif %}>
                            <td>
                                <a href="{{ check.url }}" target="_blank">{{ check.url }}</a>
                            </td>
                            <td>
                                {% if check.status_code == 200 %}
                                <span class="text-success">{{ check.status_code }}</span>
                                {% elif 300 <= check.status_code < 400 %}
                                <span class="text-warning">{{ check.status_code }}</span>
                                {% elif 400 <= check.status_code < 500 %}
                                <span class="text-danger">{{ check.status_code }}</span>
                                {% else %}
                                <span>{{ check.status_code }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if check.interesting %}
                                <span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Interesting resource found</span>
                                {% endif %}
                                
                                {% if check.redirect_to %}
                                <span>Redirects to: {{ check.redirect_to }}</span>
                                {% endif %}
                                
                                {% if check.error %}
                                <span class="text-danger">Error: {{ check.error }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if results.fuzzing_results and results.fuzzing_results is iterable and results.fuzzing_results|length > 0 %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">Parameter Fuzzing Results</h3>
        </div>
        <div class="card-body">
            {% for result in results.fuzzing_results %}
                {% if result.potential_vulnerability %}
                <div class="result-item {% if result.type == 'xss' %}high-risk{% elif result.type == 'sqli' %}high-risk{% else %}medium-risk{% endif %} mb-3">
                    <h4>Potential {{ result.type|upper }} vulnerability found</h4>
                    <div class="result-meta">
                        <strong>Parameter:</strong> {{ result.param }} |
                        <strong>Payload:</strong> <code>{{ result.payload }}</code>
                    </div>
                    <div>
                        <a href="{{ result.url }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-external-link-alt"></i> Test URL
                        </a>
                        <button type="button" class="btn btn-sm btn-outline-info" 
                                data-toggle-target="fuzzing-detail-{{ loop.index }}">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                    </div>
                    <div id="fuzzing-detail-{{ loop.index }}" style="display: none; margin-top: 10px;">
                        <div class="result-details">
                            <p><strong>URL:</strong> {{ result.url }}</p>
                            <p><strong>Status Code:</strong> {{ result.status_code }}</p>
                            <p><strong>Length Difference:</strong> {{ result.length_diff }}</p>
                            <p><strong>Reflected:</strong> {{ 'Yes' if result.reflected else 'No' }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
            
            {% if not results.fuzzing_results|selectattr('potential_vulnerability')|list %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No potential vulnerabilities found through parameter fuzzing.
            </div>
            {% endif %}
            
            {% if results.fuzzing_results is mapping and results.fuzzing_results.error %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> {{ results.fuzzing_results.error }}
            </div>
            {% endif %}
            
            {% if results.fuzzing_results is mapping and results.fuzzing_results.message %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> {{ results.fuzzing_results.message }}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% if results.zap_scan and results.zap_scan.findings %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">ZAP Scan Results</h3>
        </div>
        <div class="card-body">
            {% if results.zap_scan.findings|length > 0 %}
                {% for finding in results.zap_scan.findings %}
                <div class="result-item {% if finding.risk == 'High' %}high-risk{% elif finding.risk == 'Medium' %}medium-risk{% else %}low-risk{% endif %} mb-3">
                    <h4>{{ finding.name }}</h4>
                    <div class="result-meta">
                        <span class="vulnerability-badge badge-{{ finding.risk|lower }}">{{ finding.risk }}</span>
                        <strong>URL:</strong> {{ finding.url }} |
                        <strong>Parameter:</strong> {{ finding.parameter }}
                    </div>
                    <p>{{ finding.description }}</p>
                </div>
                {% endfor %}
            {% else %}
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> No vulnerabilities found by ZAP scan.
            </div>
            {% endif %}
            
            {% if results.zap_scan.message %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> {{ results.zap_scan.message }}
            </div>
            {% endif %}
            
            {% if results.zap_scan.error %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> {{ results.zap_scan.error }}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <div class="mt-4">
        <a href="{{ url_for('manual_testing') }}" class="btn btn-primary">
            <i class="fas fa-tools"></i> Proceed to Manual Testing
        </a>
        <form method="POST" action="{{ url_for('reports') }}" class="d-inline">
            <input type="hidden" name="target" value="{{ results.target }}">
            <input type="hidden" name="report_title" value="Vulnerability Scan Report - {{ results.target }}">
            <button type="submit" class="btn btn-secondary">
                <i class="fas fa-save"></i> Save Report
            </button>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}
