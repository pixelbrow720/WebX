{% extends 'layout.html' %}

{% block title %}Advanced Exploitation - Web Security Recon Tool{% endblock %}

{% block content %}
<div class="section">
    <h1 class="section-title">
        <i class="fas fa-bomb"></i> Advanced Exploitation
    </h1>
    <p>Combine multiple vulnerabilities to create exploitation chains and assess real-world impact.</p>
    
    <form method="POST" action="{{ url_for('advanced_exploitation') }}" class="needs-validation" novalidate>
        <div class="form-group mb-3">
            <label for="target">Target URL:</label>
            <input type="url" id="target" name="target" class="form-control" placeholder="https://example.com" required
                   value="{{ request.form.get('target', '') }}">
            <div class="invalid-feedback">
                Please enter a valid URL (e.g., https://example.com)
            </div>
            <small class="text-muted">Enter the full URL including http:// or https://</small>
        </div>
        
        <div class="form-group mb-3">
            <label>Exploitation Chain:</label>
            <div id="exploit-chain-container">
                <div class="form-group mb-2">
                    <select name="exploit_chain" class="form-control" required>
                        <option value="">Select vulnerability type</option>
                        <option value="xss">Cross-Site Scripting (XSS)</option>
                        <option value="sql_injection">SQL Injection</option>
                        <option value="csrf">Cross-Site Request Forgery (CSRF)</option>
                        <option value="idor">Insecure Direct Object Reference (IDOR)</option>
                        <option value="ssti">Server-Side Template Injection (SSTI)</option>
                        <option value="auth_bypass">Authentication Bypass</option>
                        <option value="privilege_escalation">Privilege Escalation</option>
                    </select>
                </div>
            </div>
            <button type="button" id="add-exploit-item" class="btn btn-sm btn-outline-secondary mt-2">
                <i class="fas fa-plus"></i> Add another step
            </button>
            <small class="text-muted d-block mt-2">
                Create a chain of vulnerabilities to demonstrate how an attacker might escalate their attack
            </small>
        </div>
        
        <div class="form-group mb-3">
            <label for="custom_payload">Custom Payload (Optional):</label>
            <input type="text" id="custom_payload" name="custom_payload" class="form-control"
                   value="{{ request.form.get('custom_payload', '') }}">
            <small class="text-muted">Custom payload to use in exploitation attempts</small>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-play"></i> Execute Exploitation Chain
            </button>
        </div>
    </form>
</div>

{% if results %}
<div class="section">
    <h2 class="section-title">
        <i class="fas fa-clipboard-list"></i> Advanced Exploitation Results
    </h2>
    
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">Exploitation Information</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <tr>
                    <th width="30%">Target URL:</th>
                    <td>{{ results.target }}</td>
                </tr>
                <tr>
                    <th>Exploitation Chain:</th>
                    <td>
                        {% for step in results.exploit_chain %}
                        <span class="badge bg-secondary">{{ step }}</span>
                        {% if not loop.last %} â†’ {% endif %}
                        {% endfor %}
                    </td>
                </tr>
                <tr>
                    <th>Timestamp:</th>
                    <td>{{ results.timestamp }}</td>
                </tr>
                <tr>
                    <th>Overall Success:</th>
                    <td>
                        {% if results.success %}
                        <span class="text-success"><i class="fas fa-check-circle"></i> Successful</span>
                        {% else %}
                        <span class="text-danger"><i class="fas fa-times-circle"></i> Failed</span>
                        {% endif %}
                    </td>
                </tr>
                {% if results.success %}
                <tr>
                    <th>Impact:</th>
                    <td>
                        {% if results.final_impact == 'Critical' %}
                        <span class="vulnerability-badge badge-high">Critical</span>
                        {% elif results.final_impact == 'High' %}
                        <span class="vulnerability-badge badge-high">High</span>
                        {% elif results.final_impact == 'Medium' %}
                        <span class="vulnerability-badge badge-medium">Medium</span>
                        {% elif results.final_impact == 'Low' %}
                        <span class="vulnerability-badge badge-low">Low</span>
                        {% else %}
                        <span class="vulnerability-badge badge-low">{{ results.final_impact }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            </table>
        </div>
    </div>
    
    {% if results.error %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-circle"></i> Error: {{ results.error }}
    </div>
    {% endif %}
    
    {% if results.chain_results %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">Exploitation Chain Steps</h3>
        </div>
        <div class="card-body">
            <div class="exploitation-chain">
                {% for step in results.chain_results %}
                <div class="result-item {% if step.success %}medium-risk{% endif %} mb-3">
                    <h4>
                        Step {{ loop.index }}: {{ step.exploitation_type|replace('_', ' ')|title if step.exploitation_type else step.step }}
                        {% if step.success %}
                        <span class="text-success"><i class="fas fa-check-circle"></i></span>
                        {% elif 'success' in step and not step.success %}
                        <span class="text-danger"><i class="fas fa-times-circle"></i></span>
                        {% endif %}
                    </h4>
                    
                    {% if step.error %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Error: {{ step.error }}
                    </div>
                    {% endif %}
                    
                    {% if step.success %}
                        {% if step.exploitation_type == 'xss' %}
                        <div class="result-meta">
                            <strong>Vulnerable Parameter:</strong> {{ step.vulnerable_parameter }} |
                            <strong>Payload:</strong> <code>{{ step.payload }}</code>
                        </div>
                        {% if step.next_url %}
                        <div>
                            <a href="{{ step.next_url }}" target="_blank" class="btn btn-sm btn-outline-secondary mt-2">
                                <i class="fas fa-external-link-alt"></i> Test URL
                            </a>
                        </div>
                        {% endif %}
                        
                        {% elif step.exploitation_type == 'sql_injection' %}
                        <div class="result-meta">
                            {% if step.vulnerable_parameter %}
                            <strong>Vulnerable Parameter:</strong> {{ step.vulnerable_parameter }} |
                            {% endif %}
                            {% if step.vulnerable_form %}
                            <strong>Vulnerable Form:</strong> {{ step.vulnerable_form }} |
                            {% endif %}
                            <strong>Payload:</strong> <code>{{ step.payload }}</code>
                        </div>
                        <div class="mt-2">
                            <p><strong>Evidence:</strong> {{ step.evidence }}</p>
                        </div>
                        {% if step.next_url %}
                        <div>
                            <a href="{{ step.next_url }}" target="_blank" class="btn btn-sm btn-outline-secondary mt-2">
                                <i class="fas fa-external-link-alt"></i> Test URL
                            </a>
                        </div>
                        {% endif %}
                        
                        {% elif step.exploitation_type == 'csrf' %}
                        <div class="result-meta">
                            <strong>Vulnerable Form:</strong> {{ step.vulnerable_form }}
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-info mt-2" 
                                    data-toggle-target="csrf-poc-{{ loop.index }}">
                                <i class="fas fa-code"></i> View CSRF PoC
                            </button>
                        </div>
                        <div id="csrf-poc-{{ loop.index }}" style="display: none; margin-top: 10px;">
                            <pre><code class="language-html">{{ step.proof_of_concept }}</code></pre>
                        </div>
                        
                        {% elif step.exploitation_type == 'idor' %}
                        <div class="result-meta">
                            {% if step.parameter %}
                            <strong>Parameter:</strong> {{ step.parameter }} |
                            <strong>Original Value:</strong> {{ step.original_value }} |
                            <strong>Tested Value:</strong> {{ step.tested_value }}
                            {% endif %}
                            {% if step.original_id %}
                            <strong>Original ID:</strong> {{ step.original_id }} |
                            <strong>Tested ID:</strong> {{ step.tested_id }}
                            {% endif %}
                        </div>
                        {% if step.test_url %}
                        <div>
                            <a href="{{ step.test_url }}" target="_blank" class="btn btn-sm btn-outline-secondary mt-2">
                                <i class="fas fa-external-link-alt"></i> Test URL
                            </a>
                        </div>
                        {% endif %}
                        <div class="mt-2">
                            <p><strong>Similarity:</strong> {{ (step.similarity * 100)|round(2) if step.similarity else 'N/A' }}%</p>
                        </div>
                        
                        {% elif step.exploitation_type == 'ssti' %}
                        <div class="result-meta">
                            {% if step.vulnerable_parameter %}
                            <strong>Vulnerable Parameter:</strong> {{ step.vulnerable_parameter }} |
                            {% endif %}
                            {% if step.vulnerable_form %}
                            <strong>Vulnerable Form:</strong> {{ step.vulnerable_form }} |
                            <strong>Method:</strong> {{ step.form_method }}
                            {% endif %}
                            <strong>Payload:</strong> <code>{{ step.payload }}</code>
                        </div>
                        {% if step.test_url %}
                        <div>
                            <a href="{{ step.test_url }}" target="_blank" class="btn btn-sm btn-outline-secondary mt-2">
                                <i class="fas fa-external-link-alt"></i> Test URL
                            </a>
                        </div>
                        {% endif %}
                        
                        {% elif step.exploitation_type == 'auth_bypass' %}
                        <div class="result-meta">
                            <strong>Login URL:</strong> {{ step.login_url }} |
                            <strong>Username Field:</strong> {{ step.username_field }} |
                            <strong>Payload:</strong> <code>{{ step.payload }}</code>
                        </div>
                        {% if step.next_url %}
                        <div>
                            <a href="{{ step.next_url }}" target="_blank" class="btn btn-sm btn-outline-secondary mt-2">
                                <i class="fas fa-external-link-alt"></i> Test URL
                            </a>
                        </div>
                        {% endif %}
                        
                        {% elif step.exploitation_type == 'privilege_escalation' %}
                        <div class="result-meta">
                            {% if step.parameter %}
                            <strong>Parameter:</strong> {{ step.parameter }} |
                            <strong>Value:</strong> {{ step.value }}
                            {% endif %}
                            {% if step.profile_url %}
                            <strong>Profile URL:</strong> {{ step.profile_url }} |
                            <strong>Original ID:</strong> {{ step.original_id }} |
                            <strong>Test ID:</strong> {{ step.test_id }}
                            {% endif %}
                        </div>
                        {% if step.test_url %}
                        <div>
                            <a href="{{ step.test_url }}" target="_blank" class="btn btn-sm btn-outline-secondary mt-2">
                                <i class="fas fa-external-link-alt"></i> Test URL
                            </a>
                        </div>
                        {% endif %}
                        {% if step.evidence %}
                        <div class="mt-2">
                            <p><strong>Evidence:</strong> {{ step.evidence }}</p>
                        </div>
                        {% endif %}
                        {% if step.new_admin_link %}
                        <div class="mt-2">
                            <p><strong>New Admin Link Found:</strong> {{ step.new_admin_link }}</p>
                        </div>
                        {% endif %}
                        
                        {% endif %}
                    {% else %}
                        {% if step.reason %}
                        <div class="mt-2">
                            <p><strong>Reason:</strong> {{ step.reason }}</p>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="mt-4">
        <a href="{{ url_for('reports') }}" class="btn btn-primary">
            <i class="fas fa-file-alt"></i> Go to Reports
        </a>
        <form method="POST" action="{{ url_for('reports') }}" class="d-inline">
            <input type="hidden" name="target" value="{{ results.target }}">
            <input type="hidden" name="report_title" value="Advanced Exploitation Report - {{ results.target }}">
            <button type="submit" class="btn btn-secondary">
                <i class="fas fa-save"></i> Save Report
            </button>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}
